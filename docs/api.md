<!-- This file is autogenerated, do not modify directly,
     If you wish to edit the contents update the documentation
     comments or the template file: misc/api-template.md -->

# API

## Headers

Some API endpoints require specific headers to be set.
This allows us to conveniently pass contextual information to the server without having to append it manually to every request.

You don't need to set the headers manually in the client code: They are set automatically when using [`apiCall()`](/client/src/api-call.js).

### Instance

Instance specific endpoints like comments expect the current instance to be passed through the `X-Feedback-Host` header. This header simply contains the hostname of the current page. The API server parses the container subdomain ID from the header.

### Authentication

Authentication is done using the standard `Authorization` header with a non-standard `Feedbacker` scheme. The content of the authorization header is a base-64 encoded **user object**. As the feedback tool may generate multiple user tokens for the same user merging them later users are represented as an object of the form:

```json
{
  "public-token-1": "private-token-1",
  "public-token-2": "private-token-2"
}
```

## Version

### [GET /api/version](../server/src/routes/version.js#L49)

Retrieve version information about the running server.

Example response
```json
{
  "gitHash": "331d54dc84a46d12e15bdc9e7b16aacf2f2741a9",
  "gitBranch": "develop"
}
```

## Comments

### [GET /api/comments](../server/src/routes/comments.js#L51)

Retrieve all comments of the current container instance.

returns JSON array of all comments grouped with reactions in database
```json
{
    "1bd8052b": {
        "id": "1bd8052b",
        "time": "2018-11-14 16:35:27",
        "text": "comment text",
        "userId": "da776df3",
        "username": "TestUser",
        "threadId": "3blkj3ad",
        "hideName": false,
        "blob": {
           "path": "/path/to/comment",
           "route": "/route/to/comment"
        },
        "reactions": [
            {
                "id": "1ddb07c8",
                "time": "2019-01-16 16:43:21",
                "userId": "da776df3",
                "emoji": "up",
                "commentId": "1bd8052b"
            }
         ]
    },
    "cb38e8f6": {
        "id": "cb38e8f6",
        "time": "2018-11-14 17:10:42",
        "text": "other comment",
        "userId": "da776df3",
        "username": "NewUser",
        "threadId": "3blkj3ad",
        "blob": {
           "route": "/"
        },
        "reactions": []
    }
}
```
### [POST /api/comments](../server/src/routes/comments.js#L105)

Adds comment to the current container instance.

Example body for a root comment
```json
{
  "text": "comment",
  "blob": {
     "route": "/",
     "path": "/path/to/element"
   }
}
```
comments can be linked to a thread with
```json
{
  "text": "thread comment",
  "threadId": "1234",
  "blob": {
     "route": "/",
     "path": "/path/to/element"
   }
}
```

Returns `{ id, threadId }` of the new comment

### [DELETE /api/comments/:id](../server/src/routes/comments.js#L151)

Tries to delete a comment. Only successful if the userId of the comment is the same
as the user trying to delete the comment, or if the user is a dev.

Returns the numbers of rows affected,
one if the comment was deleted and 0 if it was not successful.

e.g.
```json
{
  "delRows": 1
}
```

### [GET /api/comments/:threadId](../server/src/routes/comments.js#L131)

Get comments by `threadId`

returns JSON array of all comments in thread

## Questions

### [GET /api/questions](../server/src/routes/questions.js#L22)

Retrieve all questions in the current container instance.

returns JSON array of all questions of instance
### [POST /api/questions](../server/src/routes/questions.js#L54)

adds question to database.

Example body
```json
{
  "text": "What do you think?",
  "type": "text"
}
```

Returns `{ id }` of the created question

### [DELETE /api/questions/:id](../server/src/routes/questions.js#L85)

Delete a previously posted question
### [PUT /api/questions/:id](../server/src/routes/questions.js#L101)

Update a previously posted question

### [POST /api/questions/order](../server/src/routes/questions.js#L128)

Re-order questions, accepts a body like
```json
{
  order: ['id-1', 'id-2', 'id-3']
}
```

### Answers

### [POST /api/answers](../server/src/routes/answers.js#L14)

adds answer to database

Returns `{ id }` of the added answer

### [GET /api/answers/:questionId](../server/src/routes/answers.js#L29)

Returns answer of a user for specific question
### [PUT /api/answers/:questionId](../server/src/routes/answers.js#L47)

Edits an answer of a user for specific question

## Reactions

### [POST /api/reactions](../server/src/routes/reactions.js#L20)

add reaction to a comment.

Example body
```json
{
  "emoji": "up",
  "commentId": "1bd8052b"
}
```

Returns `{ id }` of the reaction
### [DELETE /api/reactions](../server/src/routes/reactions.js#L37)

Remove reaction from a comment.

Returns empty JSON if deletion was succesful

## Users

### [POST /api/users](../server/src/routes/users.js#L24)

Add user to database.
Returns JSON that contains generated id and secret of added user.
The body can be empty to create a new anonymous user which is the default
mode of interaction in the frontend.
Alternatively you can specify properties for the new user,
eg.
```json
{
  "name": "testuser"
}
```

Example response
```json
{
    "id": "d6ac55e9",
    "secret": "ea2ca2565f484906bfd5096126816a"
}
```
### [PUT /api/users](../server/src/routes/users.js#L45)

Change username of existing user.
The user is specified using the Authorization header as with other endpoints
and the body should contain the new name eg.
```json
{
   "name": "Testuser2",
}
```

### [GET /api/users/role](../server/src/routes/users.js#L75)

Retrieve the role of the current user in the container.
Returns either `"dev"` or `"user"`

Example body
```json
{
  "role": "user"
}
```

## Instances

### [GET /api/instances](../server/src/routes/instances.js#L24)

Retrieve all instances in the database.

Returns 200 OK and a JSON array of all instances or 500 ISE if an error occurred.

### [POST /api/instances/new](../server/src/routes/instances.js#L59)

Create a new instance.

Currently the only parameter considered is `instance_image`. The name and subdomain are
generated automatically.

Example body
```json
{
 "type": "node"
}
```

Returns 200 OK if the operation completed successfully and 500 ISE if an error occurred.

### [GET /api/instances/logs/:name](../server/src/routes/instances.js#L37)

Retrieve logs of an instance.

Returns 200 OK and a string with logs or 500 ISE if an error occurred.

### [POST /api/instances/start](../server/src/routes/instances.js#L126)

Start a stopped container.

Example body
```json
{
 "name": "testapp-ab012"
}
```

Returns 200 OK if the operation completed successfully and 500 ISE if an error occurred.

### [POST /api/instances/stop](../server/src/routes/instances.js#L107)

Stop a running container.

Example body
```json
{
 "name": "testapp-ab012"
}
```

Returns 200 OK if the operation completed successfully and 500 ISE if an error occurred.

### [POST /api/instances/delete](../server/src/routes/instances.js#L145)

Delete a container

Example body
```json
{
 "name": "testapp-ab012"
}
```

Returns 200 OK if the operation completed successfully and 500 ISE if an error occurred.

## Instance runners

### [GET /api/instanceRunners](../server/src/routes/instanceRunners.js#L21)

Retrieve all instance runners in the database and configured system default
runners.

Fields present in the instance objects are: tag, time, use_id, size, status

Returns 200 OK and a JSON array of all instance runners or the system runners
if
  a) the user doesn't have any custom runners or
  b) the user isn't authenticated properly

### [POST /api/instanceRunners/new](../server/src/routes/instanceRunners.js#L47)

Create a new instance runner for the user. The image is pulled from the
Docker Hub. There is currently no limitations on how large or many images a
user can pull.

Example request body:

```json
{
 "tag": "nginx:latest"
}
```

Always returns 200 OK. Readiness should be monitored from `/api/instanceRunners`
in the `status` field.

### [POST /api/instanceRunners/delete](../server/src/routes/instanceRunners.js#L65)

Deletes an instance runner. This will also cleanup space used on disk, so
if per-user quotas are implemented later, this is the way instance runner
management can be done.

Example request body:

```json
{
 "tag": "nginx:latest"
}
```

Always returns 200 OK. Readiness should be monitored from `/api/instanceRunners`
in the `status` field.
